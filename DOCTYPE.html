<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okinawa Trip Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react/": "https://aistudiocdn.com/react@^19.2.0/",
        "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
        "firebase/app": "https://aistudiocdn.com/firebase@^12.6.0/app",
        "firebase/auth": "https://aistudiocdn.com/firebase@^12.6.0/auth",
        "firebase/firestore": "https://aistudiocdn.com/firebase@^12.6.0/firestore",
        "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
      }
    }
    </script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import React, { useState, useEffect, useCallback, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, onSnapshot, setDoc, doc, query, orderBy, getDocs, limit, addDoc, serverTimestamp, deleteDoc, updateDoc } from 'firebase/firestore';
        import { 
            AlertTriangle, Map as MapIcon, Utensils, ShoppingBag, Landmark, Briefcase, 
            Plane, Euro, Plus, User, Trash2, CheckSquare, Edit, Save, X, RotateCcw,
            Wallet, ArrowDownCircle, ArrowUpCircle 
        } from 'lucide-react';

        // --- CONSTANTS ---
        const JPY_TO_TWD_RATE = 0.22;

        const PAYER_OPTIONS = [
            { id: 'CN', name: 'CN' },
            { id: 'KT', name: 'KT' },
            { id: 'GROUP', name: '共同基金' },
        ];

        const ACTIVITY_TYPES = [
            { value: 'TRANSPORT', label: '交通', icon: Plane },
            { value: 'FOOD', label: '餐飲', icon: Utensils },
            { value: 'SIGHTSEEING', label: '觀光/景點', icon: Landmark },
            { value: 'SHOPPING', label: '購物', icon: ShoppingBag },
            { value: 'HOTEL', label: '住宿', icon: Briefcase },
            { value: 'OTHER', label: '其他', icon: MapIcon },
        ];

        const INITIAL_TRIP_DATA = [
            { day: 1, date: '12/18', location: '那霸市區', activities: [
                { time: '13:20', type: 'TRANSPORT', name: '抵達桃園機場辦理登機', guide: '請預留充裕時間前往桃園機場第一航廈樂桃航空櫃檯辦理登機手續與行李托運。' },
                { time: '15:20', type: 'TRANSPORT', name: '桃園機場 MM926' },
                { time: '17:50', type: 'TRANSPORT', name: '抵達那霸機場', details: { name_jp: '那覇空港', location_link: 'https://www.google.com/maps/search/?api=1&query=那覇空港' } },
                { time: '18:15', type: 'HOTEL', name: '住宿：那霸西鐵渡假客棧', details: { name_jp: '西鉄リゾートイン那覇', location_link: 'https://www.google.com/maps/search/?api=1&query=西鉄リゾートイン那覇' } },
                { time: '20:30', type: 'FOOD', name: '晚餐：焼肉 琉球の牛 （那覇久茂地店）', details: { name_jp: '焼肉 琉球の牛 (那覇久茂地店)', address: '那霸市久茂地 3-29-23', phone: '098-951-3323', guide: '推薦特選和牛六種盛り', location_link: 'https://www.google.com/maps/search/?api=1&query=焼肉+琉球の牛+那覇久茂地店' } },
            ]},
            { day: 2, date: '12/19', location: '中部', activities: [
                { time: '08:00', type: 'TRANSPORT', name: 'Flip Flop Rent Car 取車', details: { name_jp: 'フリップフロップレンタカー', location_link: 'https://www.google.com/maps/search/?api=1&query=フリップフロップレンタカー' } },
                { time: '09:00', type: 'SIGHTSEEING', name: 'DMM kariyushi水族館', details: { name_jp: 'DMMかりゆし水族館', location_link: 'https://www.google.com/maps/search/?api=1&query=DMMかりゆし水族館', guide: '互動式數位水族館，適合拍照' } },
                { time: '12:30', type: 'SHOPPING', name: 'Iias 沖繩豐崎', details: { name_jp: 'イーアス沖縄豊崎', location_link: 'https://www.google.com/maps/search/?api=1&query=イーアス沖縄豊崎' } },
                { time: '15:30', type: 'SIGHTSEEING', name: '萬座毛（Manzamo）懸崖海景觀賞', details: { name_jp: '万座毛', guide: '象鼻岩，壯觀海景', location_link: 'https://www.google.com/maps/search/?api=1&query=万座毛' } },
                { time: '16:15', type: 'HOTEL', name: '住宿：Royal View Hotel Churaumi', details: { name_jp: 'ロイヤルビューホテル美ら海', location_link: 'https://www.google.com/maps/search/?api=1&query=ロイヤルビューホテル美ら海' } },
                { time: '19:30', type: 'FOOD', name: '晚餐：牛排屋88 美麗海店', details: { name_jp: 'ステーキハウス88 美ら海店', guide: '沖繩老牌牛排店', location_link: 'https://www.google.com/maps/search/?api=1&query=ステーキハウス88+美ら海店' } },
            ]},
            { day: 3, date: '12/20', location: '海洋博公園', activities: [
                { time: '08:30', type: 'SIGHTSEEING', name: '沖繩美麗海水族館', details: { name_jp: '沖縄美ら海水族館', guide: '黑潮之海鯨鯊餵食秀', location_link: 'https://www.google.com/maps/search/?api=1&query=沖縄美ら海水族館' } },
                { time: '12:30', type: 'FOOD', name: '古宇利蝦蝦飯', details: { name_jp: 'Kouri Shrimp', guide: '蒜蓉蝦飯，排隊美食', location_link: 'https://www.google.com/maps/search/?api=1&query=Kouri+Shrimp' } },
                { time: '14:00', type: 'SIGHTSEEING', name: '古宇利島周邊遊玩與拍照', details: { name_jp: '古宇利島', guide: '跨海大橋美景', location_link: 'https://www.google.com/maps/search/?api=1&query=古宇利島' } },
                { time: '19:30', type: 'FOOD', name: '晚餐：Kijimunaa 塔可飯 或美國村周邊用餐', details: { name_jp: 'きじむなぁ (美國村店)', guide: '美式塔可飯，沖繩特色料理', location_link: 'https://www.google.com/maps/search/?api=1&query=きじむなぁ+デポアイランド店' } },
            ]},
            { day: 4, date: '12/21', location: '那霸', activities: [
                { time: '10:00', type: 'SHOPPING', name: '永旺夢樂城沖繩來客夢購物', details: { name_jp: 'イオンモール沖縄ライカム', location_link: 'https://www.google.com/maps/search/?api=1&query=イオンモール沖縄ライカム' } },
                { time: '12:30', type: 'FOOD', name: '敘敘苑燒肉（浦添PARCO CITY店）', details: { name_jp: '叙々苑 浦添パルコシティ店', guide: '高級燒肉，建議提前預約', location_link: 'https://www.google.com/maps/search/?api=1&query=叙々苑+浦添パルコシティ店' } },
                { time: '15:30', type: 'SIGHTSEEING', name: '首里城公園（外圍區域參觀）', details: { name_jp: '首里城公園', guide: '世界遺產，主要建築正在修復', location_link: 'https://www.google.com/maps/search/?api=1&query=首里城公園' } },
                { time: '17:00', type: 'SIGHTSEEING', name: '波上宮＆波之上海灘', details: { name_jp: '波上宮・波の上ビーチ', guide: '海邊神社，獨特景觀', location_link: 'https://www.google.com/maps/search/?api=1&query=波上宮' } },
                { time: '18:30', type: 'TRANSPORT', name: '歸還租賃汽車 (Flip Flop Rent Car)', details: { name_jp: 'フリップフロップレンタカー還車處', location_link: 'https://www.google.com/maps/search/?api=1&query=フリップフロップレンタカー' } },
            ]},
            { day: 5, date: '12/22', location: '瀨長島', activities: [
                { time: '09:00', type: 'SIGHTSEEING', name: '瀨長島 (Umikaji Terrace) 觀光/咖啡', details: { name_jp: '瀬長島ウミカジテラス', guide: '白色小屋，購物休閒', location_link: 'https://www.google.com/maps/search/?api=1&query=瀬長島ウミカジテラス' } },
                { time: '11:00', type: 'TRANSPORT', name: '從瀨長島前往那霸機場' },
                { time: '11:30', type: 'TRANSPORT', name: '抵達機場 & 辦理登機手續', details: { name_jp: '那覇空港 (國內線/國際線)', location_link: 'https://www.google.com/maps/search/?api=1&query=那覇空港' } },
                { time: '13:35', type: 'TRANSPORT', name: '搭乘樂桃 MM925 賦歸台北' },
            ]},
        ];

        // --- SERVICES ---
        
        // Access global variables safely
        const getGlobalVar = (key, defaultVal) => {
            return (typeof window !== 'undefined' && typeof window[key] !== 'undefined') ? window[key] : defaultVal;
        };

        const appIdGlobal = getGlobalVar('__app_id', 'default-okinawa-trip-app');
        const firebaseConfigStr = getGlobalVar('__firebase_config', '{}');
        const initialAuthTokenGlobal = getGlobalVar('__initial_auth_token', null);

        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(firebaseConfigStr);
        } catch (e) {
            console.error("Failed to parse firebase config", e);
        }

        const useFirebaseSetup = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                if (!firebaseConfig || !Object.keys(firebaseConfig).length) {
                    console.warn("Firebase configuration is missing. Running in offline/demo mode.");
                    setIsAuthReady(true);
                    // Generate a fake user ID for demo mode
                    setUserId('demo-user-' + Math.floor(Math.random() * 1000));
                    return;
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    const firestoreDb = getFirestore(app);
                    const firebaseAuth = getAuth(app);

                    setDb(firestoreDb);
                    setAuth(firebaseAuth);

                    const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                        if (user) {
                            setUserId(user.uid);
                        } else if (initialAuthTokenGlobal) {
                            try {
                                await signInWithCustomToken(firebaseAuth, initialAuthTokenGlobal);
                                if (firebaseAuth.currentUser) {
                                    setUserId(firebaseAuth.currentUser.uid);
                                }
                            } catch (error) {
                                console.error("Custom token sign-in failed, signing in anonymously:", error);
                                await signInAnonymously(firebaseAuth);
                                if (firebaseAuth.currentUser) {
                                    setUserId(firebaseAuth.currentUser.uid);
                                }
                            }
                        } else {
                            await signInAnonymously(firebaseAuth);
                            if (firebaseAuth.currentUser) {
                                setUserId(firebaseAuth.currentUser.uid);
                            }
                        }
                        setIsAuthReady(true);
                    });

                    return () => unsubscribe();
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    setIsAuthReady(true);
                }
            }, []);

            return { db, auth, userId, isAuthReady, appId: appIdGlobal };
        };

        const useTripData = (db, userId, isAuthReady, appId) => {
            const [expenses, setExpenses] = useState([]);
            const [itinerary, setItinerary] = useState([]);
            const [loading, setLoading] = useState(true);

            // Initialize itinerary if online
            const initializeItinerary = useCallback(async (firestoreDb, currentAppId) => {
                const itineraryCollection = collection(firestoreDb, `artifacts/${currentAppId}/public/data/itinerary`);
                const q = query(itineraryCollection, limit(1));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    console.log("Itinerary collection empty, initializing with default data.");
                    try {
                        await Promise.all(INITIAL_TRIP_DATA.map(dayPlan =>
                            setDoc(doc(itineraryCollection, `day-${dayPlan.day}`), dayPlan)
                        ));
                        console.log("Itinerary initialized successfully.");
                    } catch (e) {
                        console.error("Error initializing itinerary:", e);
                    }
                }
            }, []);

            // Initial Load / Subscription
            useEffect(() => {
                if (!isAuthReady) {
                    setLoading(true);
                    return;
                }

                // Offline / Demo mode
                if (!db) {
                    if (itinerary.length === 0) setItinerary(INITIAL_TRIP_DATA);
                    // Keep existing expenses if any, or init empty
                    if (expenses.length === 0) setExpenses([]);
                    setLoading(false);
                    return;
                }
                
                if (!userId) {
                    return;
                }

                setLoading(true);
                initializeItinerary(db, appId);

                // 1. Expense Listener
                const expenseCollectionPath = `artifacts/${appId}/public/data/expenses`;
                const qExpenses = query(
                    collection(db, expenseCollectionPath),
                    orderBy('timestamp', 'desc'),
                    limit(100)
                );

                const unsubscribeExpenses = onSnapshot(qExpenses, (snapshot) => {
                    const fetchedExpenses = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().timestamp ? doc.data().timestamp.toDate().toLocaleString() : 'N/A',
                        rawTimestamp: doc.data().timestamp
                    }));
                    setExpenses(fetchedExpenses);
                }, (error) => {
                    console.error("Error fetching expenses:", error);
                });

                // 2. Itinerary Listener
                const itineraryCollectionPath = `artifacts/${appId}/public/data/itinerary`;
                const qItinerary = query(
                    collection(db, itineraryCollectionPath),
                    orderBy('day', 'asc')
                );

                const unsubscribeItinerary = onSnapshot(qItinerary, (snapshot) => {
                    const fetchedItinerary = snapshot.docs.map(doc => doc.data());
                    fetchedItinerary.sort((a, b) => a.day - b.day);
                    setItinerary(fetchedItinerary);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching itinerary:", error);
                    setLoading(false);
                });

                return () => {
                    unsubscribeExpenses();
                    unsubscribeItinerary();
                };
            }, [db, userId, isAuthReady, appId, initializeItinerary]);


            // --- ACTIONS (Support both Online & Offline) ---

            const addExpense = useCallback(async (expenseData) => {
                const timestamp = new Date();
                
                if (db) {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/expenses`), {
                        ...expenseData,
                        userId,
                        timestamp: serverTimestamp(),
                    });
                } else {
                    // Offline mode
                    const newExpense = {
                        id: Date.now().toString(),
                        ...expenseData,
                        userId,
                        timestamp: timestamp.toLocaleString(),
                        rawTimestamp: timestamp,
                    };
                    setExpenses(prev => [newExpense, ...prev]);
                }
            }, [db, appId, userId]);

            const deleteExpense = useCallback(async (expenseId) => {
                if (db) {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/expenses`, expenseId));
                } else {
                    setExpenses(prev => prev.filter(e => e.id !== expenseId));
                }
            }, [db, appId]);

            const saveActivity = useCallback(async (dayNumber, activityData, index) => {
                // Find current day plan from state to ensure we have latest data
                // In online mode, we re-fetch effectively via the update logic, but we need the current structure
                let currentItinerary = itinerary;
                const dayPlan = currentItinerary.find(d => d.day === dayNumber);
                if (!dayPlan) return;

                const newActivities = [...dayPlan.activities];
                if (index === null) {
                    // New activity
                    newActivities.push(activityData);
                } else {
                    // Update activity
                    newActivities[index] = activityData;
                }

                // SORT BY TIME
                newActivities.sort((a, b) => {
                    const timeA = a.time || '00:00';
                    const timeB = b.time || '00:00';
                    return timeA.localeCompare(timeB);
                });

                if (db) {
                    const dayDocRef = doc(db, `artifacts/${appId}/public/data/itinerary`, `day-${dayNumber}`);
                    await updateDoc(dayDocRef, {
                        activities: newActivities,
                    });
                } else {
                    setItinerary(prev => prev.map(day => {
                        if (day.day === dayNumber) {
                            return { ...day, activities: newActivities };
                        }
                        return day;
                    }));
                }
            }, [db, appId, itinerary]);

            const deleteActivity = useCallback(async (dayNumber, index) => {
                const dayPlan = itinerary.find(d => d.day === dayNumber);
                if (!dayPlan) return;
                
                const newActivities = dayPlan.activities.filter((_, i) => i !== index);

                if (db) {
                    const dayDocRef = doc(db, `artifacts/${appId}/public/data/itinerary`, `day-${dayNumber}`);
                    await updateDoc(dayDocRef, {
                        activities: newActivities,
                    });
                } else {
                     setItinerary(prev => prev.map(day => {
                        if (day.day === dayNumber) {
                            return { ...day, activities: newActivities };
                        }
                        return day;
                    }));
                }
            }, [db, appId, itinerary]);

            const resetItinerary = useCallback(async () => {
                 if (db) {
                    const itineraryCollection = collection(db, `artifacts/${appId}/public/data/itinerary`);
                    const snapshot = await getDocs(query(itineraryCollection));
                    await Promise.all(snapshot.docs.map(doc => deleteDoc(doc.ref)));
                    await Promise.all(INITIAL_TRIP_DATA.map(dayPlan =>
                        setDoc(doc(itineraryCollection, `day-${dayPlan.day}`), dayPlan)
                    ));
                 } else {
                     setItinerary(INITIAL_TRIP_DATA);
                 }
            }, [db, appId]);


            return { 
                expenses, 
                itinerary, 
                loading,
                // Export CRUD actions
                addExpense,
                deleteExpense,
                saveActivity,
                deleteActivity,
                resetItinerary
            };
        };

        // --- COMPONENTS ---

        const CherryBlossomAnimation = () => {
            const numPetals = 20;
            const petals = useMemo(() => Array.from({ length: numPetals }).map((_, i) => ({
                id: i,
                size: `${Math.random() * 8 + 4}px`,
                left: `${Math.random() * 100}vw`,
                animationDuration: `${Math.random() * 10 + 5}s`,
                animationDelay: `${Math.random() * 5}s`,
                opacity: `${Math.random() * 0.5 + 0.5}`,
                transformOrigin: `${Math.random() * 100}% ${Math.random() * 100}%`,
            })), []);

            return (
                <>
                    <style>
                        {`
                        @keyframes fall {
                            0% {
                                transform: translateY(-10vh) rotateZ(0deg) translateX(0);
                                opacity: 0;
                            }
                            10% {
                                opacity: var(--petal-opacity);
                            }
                            100% {
                                transform: translateY(100vh) rotateZ(720deg) translateX(var(--petal-sway));
                                opacity: 0;
                            }
                        }
                        @keyframes sway {
                            0% { transform: translateX(0); }
                            50% { transform: translateX(var(--petal-sway-amount)); }
                            100% { transform: translateX(0); }
                        }

                        .petal {
                            position: fixed;
                            top: -10%;
                            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23FFC0CB' d='M50 0 C 75 25, 75 75, 50 100 C 25 75, 25 25, 50 0 Z'/%3E%3C/svg%3E");
                            background-size: cover;
                            background-repeat: no-repeat;
                            background-color: transparent;
                            opacity: 0;
                            pointer-events: none;
                            z-index: 9999;
                            box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
                            animation: fall var(--animation-duration) linear var(--animation-delay) infinite,
                                       sway var(--animation-duration) ease-in-out var(--animation-delay) infinite;
                        }
                        `}
                        {petals.map(petal => (
                            `
                            .petal-${petal.id} {
                                width: ${petal.size};
                                height: ${petal.size};
                                left: ${petal.left};
                                --petal-opacity: ${petal.opacity};
                                --animation-duration: ${petal.animationDuration};
                                --animation-delay: ${petal.animationDelay};
                                --petal-sway: ${Math.random() * 200 - 100}px;
                                --petal-sway-amount: ${Math.random() * 50 - 25}px;
                                transform-origin: ${petal.transformOrigin};
                            }
                            `
                        )).join('')}
                    </style>
                    {petals.map(petal => (
                        <div key={petal.id} className={`petal petal-${petal.id}`}></div>
                    ))}
                </>
            );
        };

        const ActivityEditor = ({ dayPlan, initialActivity, activityIndex, onClose, onSave }) => {
            const isNew = initialActivity === null;
            const [formData, setFormData] = useState({
                time: initialActivity?.time || '09:00',
                type: initialActivity?.type || 'SIGHTSEEING',
                name: initialActivity?.name || '',
                guide: initialActivity?.guide || initialActivity?.details?.guide || '',
                location_link: initialActivity?.details?.location_link || '',
                name_jp: initialActivity?.details?.name_jp || '',
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                const newActivity = {
                    time: formData.time,
                    type: formData.type,
                    name: formData.name,
                    guide: formData.guide || undefined,
                    details: {
                        location_link: formData.location_link || undefined,
                        name_jp: formData.name_jp || undefined,
                        guide: formData.guide || undefined
                    }
                };

                try {
                    await onSave(dayPlan.day, newActivity, activityIndex);
                    onClose();
                } catch (error) {
                    console.error("Error saving activity:", error);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl p-6 w-full max-w-lg shadow-2xl">
                        <h3 className="text-xl font-bold mb-4 border-b pb-2 text-pink-600">{isNew ? `新增活動 - 第 ${dayPlan.day} 天` : `編輯活動 - ${initialActivity?.name}`}</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="flex space-x-4">
                                <div className="w-1/3">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">時間 (HH:MM)</label>
                                    <input
                                        type="time"
                                        name="time"
                                        value={formData.time}
                                        onChange={handleChange}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"
                                        required
                                    />
                                </div>
                                <div className="flex-1">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">活動類型</label>
                                    <select
                                        name="type"
                                        value={formData.type}
                                        onChange={handleChange}
                                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 bg-white"
                                        required
                                    >
                                        {ACTIVITY_TYPES.map(t => (
                                            <option key={t.value} value={t.value}>{t.label}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">活動名稱 (中文)</label>
                                <input
                                    type="text"
                                    name="name"
                                    value={formData.name}
                                    onChange={handleChange}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"
                                    placeholder="例如：沖繩美麗海水族館"
                                    required
                                    />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">地點名稱 (日文, 選填)</label>
                                <input
                                    type="text"
                                    name="name_jp"
                                    value={formData.name_jp}
                                    onChange={handleChange}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"
                                    placeholder="例如：沖縄美ら海水族館"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Google 地圖連結 (選填)</label>
                                <input
                                    type="url"
                                    name="location_link"
                                    value={formData.location_link}
                                    onChange={handleChange}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"
                                    placeholder="https://maps.app.goo.gl/..."
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">備註/指南 (選填)</label>
                                <textarea
                                    name="guide"
                                    value={formData.guide}
                                    onChange={handleChange}
                                    rows={2}
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"
                                    placeholder="例如：推薦黑潮之海鯨鯊餵食秀"
                                />
                            </div>

                            <div className="flex justify-end space-x-3 mt-6">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition flex items-center"
                                >
                                    <X className="w-4 h-4 mr-1" /> 取消
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 text-white bg-pink-600 rounded-lg hover:bg-pink-700 transition flex items-center"
                                >
                                    <Save className="w-4 h-4 mr-1" /> {isNew ? '新增活動' : '儲存變更'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const ExpenseTracker = ({ userId, expenses, loading, isAuthReady, onAddExpense, onDeleteExpense }) => {
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [payer, setPayer] = useState(PAYER_OPTIONS[0].id);
            const [currency, setCurrency] = useState('JPY');
            const [type, setType] = useState('EXPENSE'); // 'EXPENSE' or 'DEPOSIT'
            const [modalOpen, setModalOpen] = useState(false);
            const [deleteModal, setDeleteModal] = useState({ open: false, id: null });

            // Ensure we handle TWD conversion to JPY properly for balance calculation
            // If currency is TWD, convert to JPY (Amount / Rate)
            // If currency is JPY, keep as is
            const convertToJPY = (amt, curr) => curr === 'JPY' ? amt : amt / JPY_TO_TWD_RATE;

            const totalDepositsJPY = expenses
                .filter(e => e.type === 'DEPOSIT')
                .reduce((sum, e) => sum + convertToJPY(e.amount, e.currency), 0);

            const totalExpensesJPY = expenses
                .filter(e => !e.type || e.type === 'EXPENSE')
                .reduce((sum, e) => sum + convertToJPY(e.amount, e.currency), 0);

            const balanceJPY = totalDepositsJPY - totalExpensesJPY;

            const getPayerName = (payerId) => PAYER_OPTIONS.find(p => p.id === payerId)?.name || payerId;

            const formatCurrency = (val, curr) => {
                if (curr === 'JPY') {
                    return `¥${(Math.round(val)).toLocaleString('ja-JP')}`;
                }
                return `$${(Math.round(val)).toLocaleString('en-US')}`;
            };

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                if (!userId || !description || !amount || !payer) return;

                const expense = {
                    description,
                    amount: parseFloat(amount),
                    currency,
                    payer,
                    type, // 'EXPENSE' or 'DEPOSIT'
                };

                try {
                    await onAddExpense(expense);
                    setDescription('');
                    setAmount('');
                    setPayer(PAYER_OPTIONS[0].id);
                    setCurrency('JPY');
                    setType('EXPENSE');
                    setModalOpen(false);
                } catch (error) {
                    console.error("Error adding expense:", error);
                }
            }, [userId, description, amount, payer, currency, type, onAddExpense]);

            const handleDelete = useCallback(async () => {
                if (!deleteModal.id) return;
                try {
                    await onDeleteExpense(deleteModal.id);
                    setDeleteModal({ open: false, id: null });
                } catch (error) {
                    console.error("Error deleting expense:", error);
                }
            }, [deleteModal.id, onDeleteExpense]);

            return (
                <div className="p-4 bg-white rounded-xl shadow-lg h-full overflow-hidden flex flex-col">
                    <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 mb-4 flex items-center">
                        <Wallet className="w-6 h-6 mr-2 text-pink-500" /> 共同記帳本
                    </h2>

                    {/* Summary Cards */}
                    <div className="mb-4 grid grid-cols-3 gap-2">
                        <div className="p-2 bg-green-50 rounded-lg shadow-sm border border-green-100 flex flex-col items-center">
                            <span className="text-xs text-gray-500 font-medium">總儲值 (入金)</span>
                            <span className="text-sm font-bold text-green-600">{formatCurrency(totalDepositsJPY, 'JPY')}</span>
                        </div>
                        <div className="p-2 bg-red-50 rounded-lg shadow-sm border border-red-100 flex flex-col items-center">
                            <span className="text-xs text-gray-500 font-medium">總支出</span>
                            <span className="text-sm font-bold text-red-600">{formatCurrency(totalExpensesJPY, 'JPY')}</span>
                        </div>
                        <div className="p-2 bg-blue-50 rounded-lg shadow-sm border border-blue-100 flex flex-col items-center">
                            <span className="text-xs text-gray-500 font-medium">公費餘額</span>
                            <span className={`text-sm font-bold ${balanceJPY >= 0 ? 'text-blue-600' : 'text-red-500'}`}>
                                {formatCurrency(balanceJPY, 'JPY')}
                            </span>
                        </div>
                    </div>

                    <button
                        onClick={() => setModalOpen(true)}
                        className="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-md flex items-center justify-center mb-4"
                    >
                        <Plus className="w-5 h-5 mr-2" /> 新增紀錄
                    </button>

                    <div className="flex-grow overflow-y-auto space-y-3 pr-2">
                        {loading && <p className="text-center text-gray-500">載入中...</p>}
                        {!isAuthReady && <div className="text-center text-red-500 flex items-center justify-center"><AlertTriangle className="w-4 h-4 mr-1" /> 認證中，請稍候...</div>}
                        {!loading && expenses.length === 0 && <p className="text-center text-gray-500">目前沒有交易記錄。</p>}

                        {expenses.map((expense) => {
                            const isDeposit = expense.type === 'DEPOSIT';
                            return (
                                <div key={expense.id} className={`flex items-center justify-between p-3 rounded-xl shadow-sm border transition duration-150 ${isDeposit ? 'bg-green-50 border-green-200 hover:bg-green-100' : 'bg-white border-gray-200 hover:bg-gray-50'}`}>
                                    <div className="flex items-center space-x-3 flex-1 min-w-0">
                                        <div className={`p-2 rounded-full ${isDeposit ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                            {isDeposit ? <ArrowDownCircle className="w-5 h-5" /> : <ArrowUpCircle className="w-5 h-5" />}
                                        </div>
                                        <div className="min-w-0">
                                            <p className="font-semibold text-gray-800 truncate">{expense.description}</p>
                                            <p className="text-sm text-gray-500">
                                                <span className="font-medium mr-2">{getPayerName(expense.payer)} {isDeposit ? '儲值' : '支付'}</span> 
                                                <span className="text-xs text-gray-400">{expense.timestamp}</span>
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex items-center space-x-2 pl-2">
                                        <span className={`text-lg font-bold ${isDeposit ? 'text-green-600' : 'text-red-600'}`}>
                                            {isDeposit ? '+' : '-'}{formatCurrency(expense.amount, expense.currency)}
                                        </span>
                                        {expense.userId === userId && ( 
                                            <button
                                                onClick={() => setDeleteModal({ open: true, id: expense.id })}
                                                className="p-1 text-gray-400 hover:text-red-600 transition duration-150 rounded-full hover:bg-gray-100"
                                            >
                                                <Trash2 className="w-4 h-4" />
                                            </button>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {modalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
                                <h3 className="text-xl font-bold mb-4 border-b pb-2">新增交易紀錄</h3>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    
                                    {/* Transaction Type Toggle */}
                                    <div className="flex p-1 bg-gray-100 rounded-lg">
                                        <button
                                            type="button"
                                            onClick={() => setType('EXPENSE')}
                                            className={`flex-1 py-2 text-sm font-bold rounded-md transition duration-200 flex items-center justify-center ${type === 'EXPENSE' ? 'bg-white text-red-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                                        >
                                            <ArrowUpCircle className="w-4 h-4 mr-1" /> 支出 (Expense)
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setType('DEPOSIT')}
                                            className={`flex-1 py-2 text-sm font-bold rounded-md transition duration-200 flex items-center justify-center ${type === 'DEPOSIT' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                                        >
                                            <ArrowDownCircle className="w-4 h-4 mr-1" /> 儲值 (Income)
                                        </button>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">項目描述</label>
                                        <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500" placeholder={type === 'DEPOSIT' ? "例如：公費入金" : "例如：午餐"} required />
                                    </div>
                                    <div className="flex space-x-4">
                                        <div className="flex-1">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">金額</label>
                                            <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500" required min="1" step="1" />
                                        </div>
                                        <div className="w-24">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">幣別</label>
                                            <select value={currency} onChange={(e) => setCurrency(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 bg-white">
                                                <option value="JPY">JPY ¥</option>
                                                <option value="TWD">TWD $</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">{type === 'DEPOSIT' ? '提供者' : '付款人'}</label>
                                        <select value={payer} onChange={(e) => setPayer(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 bg-white" required>
                                            <option value="" disabled>選擇人員</option>
                                            {PAYER_OPTIONS.map(p => (<option key={p.id} value={p.id}>{p.name}</option>))}
                                        </select>
                                    </div>
                                    <div className="flex justify-end space-x-3">
                                        <button type="button" onClick={() => setModalOpen(false)} className="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">取消</button>
                                        <button type="submit" className={`px-4 py-2 text-white rounded-lg transition shadow-md ${type === 'DEPOSIT' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`}>
                                            {type === 'DEPOSIT' ? '儲存入金' : '儲存支出'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {deleteModal.open && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl text-center">
                                <AlertTriangle className="w-10 h-10 text-red-500 mx-auto mb-4" />
                                <h3 className="text-lg font-bold mb-2">確認刪除</h3>
                                <p className="text-gray-600 mb-6">您確定要刪除這筆紀錄嗎？此操作無法復原。</p>
                                <div className="flex justify-center space-x-4">
                                    <button type="button" onClick={() => setDeleteModal({ open: false, id: null })} className="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">取消</button>
                                    <button type="button" onClick={handleDelete} className="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition">刪除</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TripPlanner = ({ userId, isAuthReady, itinerary, loading, onSaveActivity, onDeleteActivity, onResetItinerary }) => {
            const [checkedActivities, setCheckedActivities] = useState({});
            const [selectedDay, setSelectedDay] = useState(1);
            const [isEditing, setIsEditing] = useState(false);
            const [editorModal, setEditorModal] = useState({ open: false, day: null, activity: null, index: null });
            const [deleteModal, setDeleteModal] = useState({ open: false, day: null, index: null });

            const toggleActivity = useCallback((dayNumber, activityIndex) => {
                const key = `${dayNumber}-${activityIndex}`;
                setCheckedActivities(prev => ({
                    ...prev,
                    [key]: !prev[key]
                }));
            }, []);

            const currentDayPlan = itinerary.find(plan => plan.day === selectedDay);

            const handleDeleteActivity = useCallback(async () => {
                if (!deleteModal.day || deleteModal.index === null) return;
                try {
                    await onDeleteActivity(deleteModal.day, deleteModal.index);
                    setDeleteModal({ open: false, day: null, index: null });
                } catch (error) {
                    console.error("Error deleting activity:", error);
                }
            }, [deleteModal, onDeleteActivity]);

            const handleResetItinerary = useCallback(async () => {
                if (!window.confirm("警告：您確定要將行程重置為初始預設值嗎？所有編輯都將遺失！")) return;

                try {
                    await onResetItinerary();
                    alert("行程已成功重置為初始版本。");
                } catch (error) {
                    console.error("Error resetting itinerary:", error);
                    alert("重置行程失敗。");
                }
            }, [onResetItinerary]);

            const getActivityIcon = (type) => {
                const activityType = ACTIVITY_TYPES.find(t => t.value === type);
                return activityType ? activityType.icon : MapIcon;
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-full">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500"></div>
                        <p className="ml-3 text-lg text-gray-600">行程數據載入中...</p>
                    </div>
                );
            }
            
            return (
                <div className="h-full overflow-y-auto">
                    <div className="p-4 pt-6 pb-6"> 
                        <div className="bg-pink-600 text-white p-4 rounded-xl shadow-xl relative">
                            <div className='pr-24'>
                                <h1 className="text-3xl font-extrabold">沖繩五天四夜行程</h1>
                                <p className="text-pink-200 mt-1 flex items-center text-sm md:text-base">
                                    <User className="w-4 h-4 mr-1" />
                                    CN 的旅遊夥伴 (共享 ID: {userId ? userId.substring(0, 6) + '...' : '連線中...'})
                                </p>
                            </div>
                            
                            <div className="absolute top-3 right-3 flex space-x-2">
                                {isEditing && (
                                    <button
                                        onClick={handleResetItinerary}
                                        className="flex items-center px-2 py-1 text-xs text-gray-700 bg-white bg-opacity-80 rounded-full hover:bg-gray-200 transition shadow-md"
                                        title="重置為初始預設行程"
                                    >
                                        <RotateCcw className="w-3 h-3 mr-1" /> 重置
                                    </button>
                                )}
                                <button
                                    onClick={() => setIsEditing(prev => !prev)}
                                    className={`flex items-center px-3 py-1 rounded-full text-sm font-bold transition duration-200 shadow-lg ${
                                        isEditing
                                            ? 'bg-red-500 text-white hover:bg-red-600'
                                            : 'bg-white text-pink-600 hover:bg-pink-100'
                                    }`}
                                    disabled={!isAuthReady}
                                >
                                    {isEditing ? <Save className="w-4 h-4 mr-1" /> : <Edit className="w-4 h-4 mr-1" />}
                                    {isEditing ? '退出' : '編輯'}
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="sticky top-0 z-20 bg-white shadow-lg border-b border-pink-200">
                        <div className="flex justify-between py-2 px-4 sm:px-6 overflow-x-auto no-scrollbar">
                            {itinerary.map(dayPlan => (
                                <button
                                    key={dayPlan.day}
                                    onClick={() => setSelectedDay(dayPlan.day)}
                                    className={`flex-1 text-center py-2 px-3 mx-1 rounded-lg transition duration-200 whitespace-nowrap min-w-[70px] ${
                                        selectedDay === dayPlan.day
                                            ? 'bg-pink-500 text-white shadow-md font-bold transform scale-105'
                                            : 'text-gray-700 bg-gray-100 hover:bg-pink-100'
                                    }`}
                                >
                                    第 {dayPlan.day} 天
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="p-4"> 
                        {currentDayPlan ? (
                            <div key={currentDayPlan.day} className="bg-white rounded-xl shadow-lg overflow-hidden border border-pink-100">
                                <div className="p-4 bg-pink-100 border-b border-pink-300 flex items-center">
                                    <div className="flex-shrink-0 w-24">
                                        <h2 className="text-xl font-bold text-pink-700">Day {currentDayPlan.day}</h2>
                                    </div>
                                    <div className="flex-1 min-w-0 ml-4">
                                        <span className="text-lg font-medium text-gray-800">
                                            {currentDayPlan.date} <span className="text-base text-gray-600">({currentDayPlan.location})</span>
                                        </span>
                                    </div>
                                </div>

                                <div className="divide-y divide-gray-200">
                                    {currentDayPlan.activities.map((activity, activityIndex) => {
                                        const Icon = getActivityIcon(activity.type);
                                        const hasLocationLink = activity.details && activity.details.location_link;
                                        const key = `${currentDayPlan.day}-${activityIndex}`;
                                        const isChecked = checkedActivities[key];
                                        const primaryGuide = activity.guide || activity.details?.guide;
                                        
                                        return (
                                            <div key={activityIndex} className={`flex items-start p-4 transition duration-150 ${isChecked ? 'bg-green-50' : 'hover:bg-gray-50'}`}>
                                                <div className="flex-shrink-0 w-24 text-sm font-semibold text-gray-900 mt-0.5 flex flex-col items-start space-y-2">
                                                    <div className='text-base'>{activity.time}</div>
                                                    <button
                                                        onClick={() => toggleActivity(currentDayPlan.day, activityIndex)}
                                                        className={`flex items-center space-x-1 p-1 px-2 text-xs font-semibold rounded-full transition duration-150 shadow-sm ${
                                                            isChecked
                                                                ? 'bg-green-100 text-green-700 border border-green-300'
                                                                : 'bg-pink-100 text-pink-600 hover:bg-pink-200'
                                                        }`}
                                                        aria-label={isChecked ? "取消完成活動" : "標記活動完成"}
                                                        disabled={isEditing}
                                                    >
                                                        <CheckSquare className="w-3 h-3" />
                                                        <span>{isChecked ? '完成' : '未完成'}</span>
                                                    </button>
                                                </div>
                                                
                                                <div className="flex-1 min-w-0 ml-4">
                                                    <div className="flex items-center space-x-2">
                                                        <Icon className="w-5 h-5 text-pink-500 flex-shrink-0" />
                                                        <p className={`font-medium text-gray-800 break-words ${isChecked ? 'line-through text-gray-500' : ''}`}>
                                                            {activity.name}
                                                        </p>
                                                    </div>
                                                    
                                                    {primaryGuide && (
                                                        <p className="mt-1 text-xs text-gray-500 pl-7 italic">{primaryGuide}</p>
                                                    )}

                                                    {activity.details && (
                                                        <div className="mt-1 text-sm text-gray-600 pl-7 space-y-1">
                                                            {activity.details.name_jp && (
                                                                <p><span className="font-medium text-pink-500">日文:</span> {activity.details.name_jp}</p>
                                                            )}
                                                            {hasLocationLink && (
                                                                <a
                                                                    href={activity.details.location_link}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    className="inline-flex items-center text-blue-500 hover:text-blue-700 transition duration-150 text-xs font-semibold mt-1 bg-blue-50 px-2 py-1 rounded-full"
                                                                >
                                                                    <MapIcon className="w-3 h-3 mr-1" />
                                                                    Google 地圖
                                                                </a>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                {isEditing && (
                                                    <div className="flex-shrink-0 flex space-x-2 ml-4">
                                                        <button
                                                            onClick={() => setEditorModal({ open: true, day: currentDayPlan, activity: activity, index: activityIndex })}
                                                            className="p-1 text-blue-500 hover:text-blue-700 transition duration-150 rounded-full hover:bg-blue-100"
                                                            title="編輯活動"
                                                        >
                                                            <Edit className="w-4 h-4" />
                                                        </button>
                                                        <button
                                                            onClick={() => setDeleteModal({ open: true, day: currentDayPlan.day, index: activityIndex })}
                                                            className="p-1 text-red-400 hover:text-red-600 transition duration-150 rounded-full hover:bg-red-100"
                                                            title="刪除活動"
                                                        >
                                                            <Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                {isEditing && (
                                    <div className="p-4 border-t border-pink-100">
                                        <button
                                            onClick={() => setEditorModal({ open: true, day: currentDayPlan, activity: null, index: null })}
                                            className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition duration-300 shadow-md flex items-center justify-center"
                                        >
                                            <Plus className="w-5 h-5 mr-2" /> 新增活動
                                        </button>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="text-center p-8 text-gray-500 bg-white rounded-xl shadow-lg">
                                請從上方選單選擇一天來查看行程細節，或等待行程數據載入。
                            </div>
                        )}
                    </div>

                    {editorModal.open && editorModal.day && (
                        <ActivityEditor
                            dayPlan={editorModal.day}
                            initialActivity={editorModal.activity}
                            activityIndex={editorModal.index}
                            onSave={onSaveActivity}
                            onClose={() => setEditorModal({ open: false, day: null, activity: null, index: null })}
                        />
                    )}
                    
                    {deleteModal.open && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl text-center">
                                <AlertTriangle className="w-10 h-10 text-red-500 mx-auto mb-4" />
                                <h3 className="text-lg font-bold mb-2">確認刪除活動</h3>
                                <p className="text-gray-600 mb-6">您確定要刪除此活動嗎？此操作無法復原。</p>
                                <div className="flex justify-center space-x-4">
                                    <button
                                        type="button"
                                        onClick={() => setDeleteModal({ open: false, day: null, index: null })}
                                        className="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                                    >
                                        取消
                                    </button>
                                    <button
                                        type="button"
                                        onClick={handleDeleteActivity}
                                        className="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition"
                                    >
                                        刪除
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            // 1. Firebase & Auth Setup
            const { db, userId, isAuthReady, appId } = useFirebaseSetup();

            // 2. Firestore Data Hook
            const { 
                expenses, 
                itinerary, 
                loading,
                addExpense,
                deleteExpense,
                saveActivity,
                deleteActivity,
                resetItinerary
            } = useTripData(db, userId, isAuthReady, appId);

            const [activeTab, setActiveTab] = useState(0);

            return (
                <div className="min-h-screen antialiased font-sans bg-gray-50 text-gray-900">
                    {/* 櫻花動畫層 (置於最頂層) */}
                    <CherryBlossomAnimation />
                    
                    {/* Header/Navigation */}
                    <header className="bg-white shadow-md fixed top-0 left-0 right-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-center items-center h-16">
                                <nav className="flex space-x-4">
                                    <button
                                        onClick={() => setActiveTab(0)}
                                        className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                                            activeTab === 0
                                                ? 'bg-pink-600 text-white shadow-lg'
                                                : 'text-gray-600 hover:bg-gray-100'
                                        }`}
                                    >
                                        🌴 行程規劃
                                    </button>
                                    <button
                                        onClick={() => setActiveTab(1)}
                                        className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${
                                            activeTab === 1
                                                ? 'bg-pink-600 text-white shadow-lg'
                                                : 'text-gray-600 hover:bg-gray-100'
                                        }`}
                                    >
                                        💰 共同記帳
                                    </button>
                                </nav>
                            </div>
                        </div>
                    </header>

                    {/* Content Area */}
                    <main className="pt-16 max-w-7xl mx-auto h-[calc(100vh-4rem)]">
                        {activeTab === 0 && (
                            <TripPlanner 
                                userId={userId}
                                isAuthReady={isAuthReady}
                                itinerary={itinerary}
                                loading={loading}
                                onSaveActivity={saveActivity}
                                onDeleteActivity={deleteActivity}
                                onResetItinerary={resetItinerary}
                            />
                        )}
                        {activeTab === 1 && (
                            <ExpenseTracker
                                userId={userId}
                                expenses={expenses}
                                loading={loading}
                                isAuthReady={isAuthReady}
                                onAddExpense={addExpense}
                                onDeleteExpense={deleteExpense}
                            />
                        )}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(
            <React.StrictMode>
                <App />
            </React.StrictMode>
        );
    </script>
</body>
</html>